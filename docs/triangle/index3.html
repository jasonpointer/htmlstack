<!DOCTYPE html>
<html>
    <head>
    <title>HTML5 Triangle Maze Game</title>
    <link  rel="stylesheet" type="text/css" href="../css/site.css" />
    <!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <style>
	    canvas {margin:3px;border:1px solid #000}
		#panel{padding:15px;}
		.row,#ans,#cur,#results{text-align:center}
		#ans,#results,#cur{font-weight:bold;font-family:"Trebuchet MS", Arial, Helvetica, sans-serif;font-size:24px;margin-bottom:5px;}
		#cur{color:green}
		#lvl{
		font-size:18px;font-weight:bold;position:absolute;top:0px;left:0px;padding:20px 40px 15px 15px ;background-color:#000;color:#fff
		}
		
</style>
    </head>
    <body>
        <div id="lvl"></div>
<section id="content">

    <div id="panel"></div>
    <div id="ans"></div>
    <div id="cur"></div>
        <div id="results"></div>
</section>

</body>
</html>
<script>
var lvl = 2

function ce(type, ident, inner, isInput) {
    var el;
    if (!isInput) {
        el = document.createElement(type);
        el.innerHTML = inner;
    } else {
        el = document.createElement('input');
        el.value = inner;
        el.type = type
    }
    el.id = ident;
    return el
}
var _ = function (selector) {
    return document.getElementById(selector)
}

function piece(val) {
    var dataImage = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAMAAADImI+JAAAAA3NCSVQICAjb4U/gAAABHVBMVEX///9ltFpZpVBSnUr4YWNIkUE/hDg4fDL/dXjyS07/dXj9bXD6a234YWP4XWD2WVv2VFfsOTzoLzHmKSvkISNpul5ouF32VFf0TE/vREfuPD7iHB5ltFpeq1RWoU1SnUr2WVtIkEA/hDjvREdSnUpWoU1SnUr0TE9ltFpltFqM1oSMz4CKz36FzHuBynaEyHmAyXV9yHN4v2x1vGr/holstGL/gYVpr19orl7/fYD/e31jq1r/dXhgpldfpVb/cXNZpVD9bXBYn1D/a236a21SnUr/Zmb4YWP4XWD/Wl32WVtIkED/VVj2VFf3VFb0TE8/hDjyS072SUs8gjY7gDXvREc4fDLuQELuPD7sOTzrMzXoLzHnLC/mKSvkISMrJIqrAAAAX3RSTlMAERERERERESIiMzMzMzMzMzMzMzNEREREREREZnd3d3d3d3eImZmq3e7//////////////////////////////////////////////////////////////////////7W/hfEAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAWdEVYdENyZWF0aW9uIFRpbWUAMTIvMjEvMTCej/OTAAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M1cbXjNgAAAQJJREFUKJHNyldTwkAUBeBr771X7C0NS4Rs1myiKxsjiIIYxPL/f4YhMcNdw4wzPnle7plzP4B/nf6u634ubcOjyZ3cWurmzOL2t6N0LHaCH45k3IGpGM5O4iyLjUfO58TfzbiCol49Jp2RC8InYtfoiIX12BVV1amnG6eXTPicSu74bKPtNM157qzCswihAXKLR4bibu7ZmoEdQEDuygw56LHPT4yCqevuC3ZTAS1HcAZNva6pavn89Q8nGPNuHpqzaOy7tfVT2U1HLghfq6Vqaw7NA/duxnmVEKDVKNXe59FjsC45WK6ItgP4CGtva/gzBHJWnppJ+ZRdNqtp+cX9NV89BSxHIHexlgAAAABJRU5ErkJggg=="
    var me = {
        init: function (stage, width, height, label, selected) {
            me.label = label
            me.width = width;
            me.height = height;
            me.stage = stage;
            me.stage.setAttribute('width', width);
            me.stage.setAttribute('height', height);
            me.stage.setAttribute('name', label);
            me.ctx = me.stage.getContext('2d');
            me.stage.addEventListener("click", function () {
                me.toggle()
            }, false)
            me.selected = !selected;
            me.disabled = false;
            me.img = new Image()
            me.img.src = dataImage;
            me.img.onload = function () {
                me.toggle()
            }
            return me
        },
        fill: function (fillcolor) {
            me.ctx.fillStyle = fillcolor;
            me.ctx.fillRect(0, 0, me.width, me.height);
        },
        draw: function (sx, sy) {
            //me.clear()
            if (me.label) {
                if (!me.disabled) {
                    if (me.selected) {
                        me.write(me.label, "red")
                    } else {
                        me.write(me.label, "white")
                    }
                } else {
                    me.write(me.label, "black")
                }
            }
            //me.ctx.drawImage(me.img, sx, sy, 20, 20, 0, 0, 20,20)
        },
        write: function (txt, labelcolor) {
            me.ctx.font = 'bold 16px sans-serif';
            me.ctx.fillStyle = labelcolor;
			me.ctx.textAlign="center";
			me.ctx.fillText(txt, 13, 20)
        },
        val: function () {
            return me.label
        },
        clear: function () {
            me.ctx.clearRect(0, 0, me.width, me.height)
        },
        on: function () {
            me.clear();
			me.fill("green")
            me.draw(0, 0)
        },
        off: function () {
            me.clear();
            me.draw(20, 0)
        },
        toggle: function () {
            if (!me.selected) {
                me.on();
                me.selected = true;
            } else {
                me.off();
                me.selected = false
            };
            me.stage.selected = me.selected
        },
        disable: function () {
            me.disabled = true
            me.clear();
            me.draw(20, 0)
        },
        enable: function () {
            me.disabled = false
            me.clear();
            me.draw(20, 0)
        },
        click: function (func) {
            me.stage.addEventListener('click', func, false);
        },
    }
    return me;
};
/*
 * Triangle Game
 * http://htmlstack.com/
 *
 * Author, Joe Maddalone
*/
Array.prototype._forEach = function (fun) {
    var len = this.length;
    if (typeof fun != "function") throw new TypeError();
    var thisp = arguments[1];
    for (var i = len; i > 0; i--) {
        if (i in this) fun.call(thisp, this[i], i, this);
    }
};
Object.prototype.clone = function () {
    var newObj = (this instanceof Array) ? [] : {};
    for (i in this) {
        if (i == 'clone') continue;
        if (this[i] && typeof this[i] == "object") {
            newObj[i] = this[i].clone();
        } else newObj[i] = this[i]
    }
    return newObj;
};
var game = function (b, u) {
    this.init(b, u)
}
game.prototype = {
    init: function (b, u) {
        this.base = b
        this.upper = u
        this.playerTotal = 0
        this.route = [];
        this.dat = new Array(b)
        for (var row = 0; row < this.base; row++) {
            this.dat[row] = new Array(this.base)
            for (var col = 0; col < this.base; col++) {
                this.dat[row][col] = 0
            }
            for (var col = 0; col <= row; col++) {
                this.dat[row][col] = this.retRnd(this.upper)
            }
        }
    },
    retRnd: function (x) {
        var ret = Math.floor(Math.random() * (x + 1));
        if (ret == 0) {
            return 1
        } else {
            return ret
        }
    },
    solve: function (t) {
        var that = this
        t._forEach(

        function (copyRowVal, copyRow, arr) {
            copyRowVal.forEach(

            function (copyColVal, copyCol, arr2) {
                if (t[copyRow][copyCol] > t[copyRow][copyCol + 1]) {
                    //that.route.push(t[copyRow- 1][copyCol] + t[copyRow][copyCol])							
                    t[copyRow - 1][copyCol] += t[copyRow][copyCol]
                } else {
                    //that.route.push(t[copyRow- 1][copyCol] + t[copyRow][copyCol+1])							
                    t[copyRow - 1][copyCol] += t[copyRow][copyCol + 1]
                }
            })
        })
        return t[0][0]
    },
    solution: function () {
        this.copy = this.dat.clone()
        return this.solve(this.copy)
    },
    add: function (val) {
        this.playerTotal += val
    },
    subtract: function (val) {
        this.playerTotal -= val
    }
}

function start(lvl) {
    _('lvl').innerHTML = 'Level: ' + (lvl-1).toString()
    _('ans').innerHTML = ''
    _('panel').innerHTML = ''
    _('results').innerHTML = ''
    _('cur').innerHTML = ''
    var g = new game(lvl, 9)
    var ans = g.solution()
    _('ans').innerHTML = 'Answer: ' + ans

    function retVal(str) {
        return g.dat[str.split('-')[0]][str.split('-')[1]]
    }
	
	function fixRow(str){
		var row = str.split('-')[0]
		var col = str.split('-')[1]
		
		for(i=0;i<row;i++){
			//if(i != col){
				_(row + '-' + i).disable();
				//}			
			}
		
		}
	
	
    g.dat.forEach(

    function (rowVal, row, arr) {
        _('panel').appendChild(ce("div", 'row-' + row, ''))
        _('row-' + row).setAttribute('class', 'row')
        rowVal.forEach(

        function (colVal, col, arr2) {
            if (colVal != 0) {
                var p = row + '-' + col
                _('row-' + row).appendChild(ce("canvas", p, ''))
                var o = new piece().init(
                _(p), 30, 30, colVal, false).click(
                function () {
                    if (!this.disabled) {
                        if (this.selected) {
                            g.add(retVal(this.id));
                            _('cur').innerHTML = 'Total: ' + g.playerTotal
							//fixRow(this.id)

                        } else {
                            g.subtract(retVal(this.id))
                        };
                        _('cur').innerHTML = 'Total: ' + g.playerTotal
                        if (g.playerTotal == ans) {
                            _('results').innerHTML = 'You Won!'
                            _('results').innerHTML += '<br /><button onClick="start(lvl+=1)">Next</button>'
                        } else {
                            _('results').innerHTML = ''
                        }
                    }
                });
            }
        })
    })
}

(function () {
    start(lvl)
})()






</script>