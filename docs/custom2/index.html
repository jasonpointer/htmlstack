<!doctype html>
<head>
<title>HTML5 video custom controls with canvas as video scrubber</title>
<meta name="description" content="controlling HTML5 video with custom controls and canvas" />
<script>

function load() {

    var player = document.getElementById('player');
    var controller = document.getElementById('controls');
    var playbutton = document.getElementById('playpause');
    var container = document.getElementById('container');
    var canvas = document.getElementById('scrubber');

    player.addEventListener('timeupdate', function(e) {
        document.getElementById('duration').innerHTML = fixtime(player.duration);
        document.getElementById('display').innerHTML = fixtime(player.currentTime) + "&nbsp;/&nbsp;";
    }, false);

    /* start */
    player.addEventListener('play', function(e) {
        playbutton.innerHTML = '<button class="pause"></button>';
    }, false);

    /* paused */
    player.addEventListener('pause', function(e) {
        playbutton.innerHTML = '<button class="play"></button>';
    }, false);

    /* end */
    player.addEventListener('ended', function(e) {
        playbutton.innerHTML = '<button class="pause"></button>';
        player.play()
        }, false);

    /* playbutton clicked */
    playbutton.addEventListener('click', function() {
        if (player.paused) {
            player.play();
        } else {
            if (player.ended) {
                player.currentTime = 0;
                player.innerHTML = '<div class="pause"></div>';
                player.play();
            } else {
                player.pause();
            }
        }
    }, false);

    function fixtime(t) {
        var s = t
        var h = Math.floor(s / 3600);
        s = s % 3600;
        var m = Math.floor(s / 60);
        s = Math.floor(s % 60);
        /* pad the minute and second strings to two digits */
        if (s.toString().length < 2)
            s = "0" + s;
        if (m.toString().length < 2)
            m = "0" + m;
        return h + ":" + m + ":" + s;
    }

    drawScrubber();

    /*Scrubber Stuffs*/

    var stopper = 0;
    function drawScrubber() {

        if (canvas.getContext) {
            canvas.width = 400;
            canvas.addEventListener("mousedown", function(e) {
                //player.pause();
                stopper = 0;
                setScrubber(e);
                canvas.addEventListener("mousemove", function(e) {
                    setScrubber(e);
                }, false);
            }, false);
            canvas.addEventListener("mouseup", function(e) {
                stopper = 1;
                //player.play()
                }, false);
            //canvas.addEventListener("mouseout",function(e) {stopper=1;player.play()},false);
            ctx = canvas.getContext('2d');
            setInterval(makeScrubber, 25);
        }
    }

    function setScrubber(e) {
        if (stopper == 0) {
            var ox = e.pageX;
            //x pos on the page itself
            var barPos = ox - findX(canvas);
            //x position relative to canvas
            //determine percentage of x across the canvas
            var xPer = (barPos / canvas.width)
            player.currentTime = player.duration * xPer;
        }
    }

    function makeScrubber() {
        var xpos = canvas.width * (player.currentTime / player.duration);

		//drawing scrubber before current position
        for (i = 0; i <= xpos; i += 8) {
            ctx.fillStyle = "red";
            ctx.fillRect(i, 0, 8, 8);
        }
		//current position
        ctx.fillStyle = "#000";
        ctx.fillRect(xpos, 0, 8, 8);

		//after current position
        for (i = xpos + 8; i <= canvas.width; i += 8) {
            ctx.fillStyle = "#fff";
            ctx.fillRect(i, 0, 8, 8);
        }

    }

    function findX(el) {
        var left = 0;
        if (el.offsetParent) {
            do {
                left += el.offsetLeft;
            }
            while (el = el.offsetParent);
            return left;
        }
    }

}
</script>




<link  rel="stylesheet" type="text/css" href="../css/site.css" />
<!--[if IE]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
<style>
#controls {
	position: absolute;
	bottom: 5px;
	left: 0px;
	width: 636px;
	height: 60px;
	opacity:0.3;
	-webkit-transition-duration: 0.5s;
	-moz-transition-duration: 0.5s;
	transition-duration: 0.5s;
}

#controls:hover{opacity:1}


.play,.pause{
	float:left;width:65px;
	}

#player{height:385px;width:640px;background-color:black}


#controls,.pause,.play,#vol{background-image:url(controls.png);}

#controls{height:25px;
	background-position:0 0px;border:0;
	padding:0px 2px;margin:0;
	}

.play{
	background-position:-0px -25px;width:27px;height:25px;border:0;
	padding:0;margin:0;display:block}

.play:hover{background-position:-28px -25px}

.pause{
	background-position:-0px -50px;width:27px;height:25px;border:0;
	padding:0;margin:0;display:block}
.pause:hover{background-position:-28px -50px}

#vol{
	background-position:-0px -75px;width:27px;height:25px;border:0;
	padding:0;margin:0;display:block}

#vol:hover{
	background-position:-28px -75px;width:27px;height:25px;border:0;
	padding:0;margin:0;display:block}



#display,#duration{float:left;color:#fff;padding-top:1px;font-size:11px;font-weight:bold}

#scrubber{cursor:pointer;float:left;margin-top:8px;margin-right:10px;border:0;}



#container{position:relative}

/* NON Video Stuffs */
.dropCase{
float: left;
 font-family: Georgia,serif;
 font-size: 400%;
 line-height: 0.9em;
 margin-right: 0.03em;
 margin-bottom:-0.1em;
}

.description{
width: 640px;;
}

pre{padding:10px;}
</style>

</head>

<body onload="load()">
<header>HTML5 video custom controls with canvas as video scrubber</header>
<section id="content">
<article>
<div id="container">
	<video width="640" height="360" id="player" loop>
		<source src="../video/htmlstack.ogv" type="video/ogg" />
		<source src="../video/htmlstack.mp4" />

		<i style="color:white"> Your browser does not support the &lt;video> element, yet</i>
	</video>
	<div id="controls">
		<div id="playpause"><button class="play"></button></div>
		<canvas id="scrubber" height="8"></canvas>
		<span id="display">--:--:--&nbsp;/&nbsp;</span>
		<span id="duration">--:--:--</span>

	</div>
</div>
</article>

<article class="description">
<p>See Also: <a href="../customcontrols">My first failed attempt</a> and <a href="../custom3">Adding Canvas HTML5 Volume Controls (#3)</a></p>

<p><span class="dropCase">S</span>o the range input I tried to use last time proved to be a disaster as well as breaking completely in Firefox.  This time around I am using the canvas element to handle the video scrubber and while not perfect, definitely a step in the right direction.</p>

<p>Presumably there are or will be canvas libraries out there that will allow more of a stage/movieclip style of coding canvas interactions but for now I prefer to learn the hard way.</p>

<p><b>Caveats I learned today:</b><br />
<ul>
<li>1. removeEventListener is useless</li>
<li>2. click event of canvas passes coordinates relative to the entire browser window.  This can be resolved by looping though each parent container and adding the offsetLeft or offsetTop from each of those to that of the canvas.  I only needed x for the scrubber.</li>


<pre>

function findX(el) {
	var left = 0;
	if (el.offsetParent) {
		do {
			left += el.offsetLeft;
		}
		while (el = el.offsetParent);
		return left;
	}
}
</pre>
<li>3. Using many small canvas elements is proving to be more manageable than one big canvas element mirroring the frames of a video stream.</li>

</ul>
</p>




<p><span class="dropCase">A</span>a you can see I am saving space for volume and full screen buttons and then I can circle back and clean up all this code, make it look better, make it work better, and wait for IE9... which interestingly enough appears to be on the horizon <a href="http://mashable.com/2009/11/18/internet-explorer-9/">clicky</a></p>
</article>
</section>

<footer>back to <a href="/">htmlstack</a></footer>


<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-91014-16");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>