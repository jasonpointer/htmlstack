<!DOCTYPE html>
<html manifest="db.cache">
<head>
<title>HTML5 DB</title>
<link  rel="stylesheet" type="text/css" href="../css/site.css" />
<style>
#interface {
	margin:10px;
	background-color:#fff;
	display:block;
	border:2px solid #666;
	float:left;
	width:740px;
}
#results {
	float:left;
	width:240px;
	height:400px;
	overflow:auto;
	padding:5px;
	border-right:1px solid #666;
	margin-right:25px;
}
#resTitle {
	float:left;
	width:220px;
	background:#999;
	padding:15px;
}
#editTitle {
	background:#ccc;
	padding:15px;
	float:left;
	width:460px
}
#resTitle, #editTitle {
	font: bold 24px/35px Helvetica, Arial, Sans-serif;
	color: #fff;
	text-shadow: 0px 2px 4px #333;
}
#results div {
	padding: 4px 17px 4px 17px;
	border-bottom: 1px dashed green;
}
#results div:hover, #results div:focus {
	color: #339;
	background: #FDFEE9;
	cursor:pointer
}
#info input[type="text"] {
	padding:5px;
	font-size:200%;
	display:block;
	margin-left:5px;
	;
	color:#666;
	font-weight:bold
}
</style>
</head>

<header>HTML5 DB / WebSQL example.</header>
<section id="content">
  <article>
    <div id="interface">
      <div id="resTitle">My Contacts</div>
      <div id="editTitle"></div>
      <div id="results"></div>
      <div id="info">
        <label>First Name</label>
        <input type="text" name="fname" id="fname" />
        <label>Last Name</label>
        <input type="text" name="lname" id="lname" />
        <label>Email Address</label>
        <input type="text" name="email" id="email" />
        <button id="add">Add</button>
        <button id="update">Update</button>
        <button id="delete">Delete</button>
        <button id="cancel">Cancel</button>
      </div>
    </div>
  </article>
  <article class="description" style="clear:both">
    <p>So the gist of it is that you can add, edit, update, and delete information in this interface.</p>
    <p>There are no cookies or session variables and nothing happens on the server side.  This is all communicating with a database that has just been placed on your machine... crazy right?</p>
    <p>What this also means is that you can disconnect your internet and the app will still work.  There's a cache manifest whch tells what files to use if you are offline.</p>
  </article>
</section>
<footer>back to <a href="/">htmlstack</a></footer>
<script>




var db;
var cid;
var formMade = false;
if (window.openDatabase) {
    window.onload = MakeDB("HTMLDBContacts", "1.4", "TestDB", 1048576);
}
else window.onload = alert("Couldn't create/open the database.");

function MakeDB(dbName, dbVersion, dbDisplay, dbSize) {
    db = openDatabase(dbName, dbVersion, dbDisplay, dbSize);
    if (!db) {
        alert("Failed to create/open the database on disk.");
    }
    else {

		ex(db,'CREATE TABLE IF NOT EXISTS ContactTbl(id INTEGER PRIMARY KEY,fname TEXT,lname TEXT, email TEXT)')
		showContacts()
    }
}



function showContacts(recs) {
       fillrecs(db,'SELECT * FROM ContactTbl order by lname',getContacts)	
	}

function getContacts(recs) {
    $("editTitle").innerHTML = "Add New";
	var results = $("results");
	results.innerHTML = '';
	for (var i = 0; i < recs.rows.length; i++) {
		var row = recs.rows.item(i);
		var rec = ce('div', row['id'] + '.rec', row['fname'] + ' ' + row['lname']);
		results.appendChild(rec)
		rec.addEventListener('click', function (rec) {showContact(this.id);cid=this.id}, false);
	}
	showForm();
}

function showForm() {
	if(!formMade)
	{
    $('add').addEventListener('click', function (e) {
        AddNew()
    }, false);
	
	$('update').addEventListener('click', function (e) {
		UpdateClick(cid);
	}, false);
	$('delete').addEventListener('click', function (e) {
		Delete(cid);
		showContacts();
	}, false);
	$('cancel').addEventListener('click', function (e) {
		showContacts()
	}, false);	
	
	$('update').hide();
	$('delete').hide();
	$('cancel').hide();	
	
	formMade = true;
	}
	else
	
	{
			$('fname').value = ''
			$('lname').value = ''
            $('email').value = ''
			cid=0
			$('update').hide();
			$('delete').hide();
			$('cancel').hide();
			$('add').show();
		
		}
	
}

function showContact(cid) {
    $("editTitle").html("Edit");
    db.transaction(function (tx) {
        tx.executeSql('SELECT * FROM ContactTbl where id=?', [cid.replace('.rec', '')], function (tx, rs) {
            var info = $("info");
            var row = rs.rows.item(0);
			$('fname').value = row['fname']
			$('lname').value = row['lname']
            $('email').value = row['email']
			$('update').show();
			$('delete').show();
			$('cancel').show();	
			$('add').hide();				
			
   
        });
    });
}


function AddNew() {
    var fname = $("fname").value
    var lname = $("lname").value
    var email = $("email").value
    db.transaction(function (tx) {tx.executeSql("INSERT INTO ContactTbl (fname,lname,email) VALUES (?, ?, ?)", [fname, lname, email])});
    showContacts();
}

function Delete(cid) {
	ex(db,"DELETE from ContactTbl WHERE id=" + cid.replace('.rec', ''))
}

function UpdateClick(cid) {
    Delete(cid); //yes I am THAT lazy!!!
    AddNew()
}

/*

joe's Library


*/
function $(selector) {
	return document.getElementById(selector);
}	

function ex(db,tx){
	db.transaction(function (sql) {sql.executeSql(tx);});	
}

function fillrecs(db,tx,callback){
		//db.transaction(function (sql) {sql.executeSql(tx, [], function (sql, rs) {return rs});});
		db.readTransaction(function(sql){
		sql.executeSql(tx, [],
		function(sql, data){
		callback(data); });
		});		
}

function ce(type, ident, inner) {
    var el = document.createElement(type);
    el.id = ident;
    if (!inner) {} else {
        el.innerHTML = inner;
    }
    return el
}

Object.prototype.hide = function(){this.style.display = 'none';}
Object.prototype.show = function(){this.style.display = '';}
HTMLElement.prototype.html = function(str){this.innerHTML = str}
HTMLElement.prototype.append = function(str){this.innerHTML += str}
</script>
</html>
